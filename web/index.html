<!doctype html>
<html>
<head>
<title>Lemmy</title>
<script src="http://www.google.com/jsapi" type="text/javascript"></script>
<script type="text/javascript">
var root = "/f/";
var path = [];
var cache = {};
var ntab = 0;

function init() {
	load(path);
	$('audio').bind('ended', function(ev) {
		var $current = $('li.playing');
	 	if ($current.hasClass('error')) $current.removeClass('error');
		next();
	});
	$('audio').bind('play', function(ev) {
	    var $playing = $('li.playing');
		var current = $playing.data('file').Name;
		var title = $playing.attr('title');
		var $ac = $('#current');
		document.title = current;
		$ac.text(current).attr('title', title).click(player.pause);
	});
	$('audio').bind('pause', function(ev) {
		var $ac = $('#current');
		var title = '('+$ac.text()+')';
		document.title = title;
		$('#current').text(title);
	});
	$('audio').bind('error', function(ev) {
		if($('audio').attr('src') == '')
			return;
		var el = $('li.playing');
		next();
		if(el.hasClass('error')) {
			el.remove();
		} else {
			el.addClass('error');
			el.attr('title', 'Error playing '+el.data('file').Path+'/'+el.data('file').Name);
		}
	});
	$('#toplay').bind('mouseup', function(ev) {
		updatenext();
	});
	var $p = $('#toplay');
	$p.sortable({ axis: 'y' });
	$p.disableSelection();
}
function updatenext() {
    	var $next = $('li.playing').next();
    	if($next.length > 0){
        	var next = $next.data('file').Name;
         	$('#next').text(next);
         	return;
         }
         $('#next').text("");
}
function stop() {
	player = $('audio').get()[0];
	player.pause();
	player.currentTime = 0;
}
function load(path)  {
//	$('#browserpath').text(path.join('/'));
	pathlinks(path);
	var url = root+path.join('/');
	if (typeof cache[url] != "undefined") {
		populate(cache[url]);
		return;
	}
	$.ajax({
		url: url,
		dataType: "json",
		success: function(data) {
			sort(data);
			cache[url] = data;
			populate(data)
		}
	});
}
function pathlinks(p) {
	var $b = $('#browserpath').empty();
	$('<a style="padding-left:0.7em"></a>').text("/").click(function() {
		path = [];
		load(path);
	}).appendTo($b);
	var onclick = [];
	for (i in p) {
		$('<a></a>').text(p[i]+"/").click( (function(ps) {
			return function() {
				path = ps;
				load(path);
			}
		})(p.slice(0, Number(i) + 1))).appendTo($b);
	}
}
function populate(files) {
	var $b = $('#browser').empty();
	function add(i, f) {
		if (f.Name[0] == '.' || f.Name[0] == ':') return;
		var dir = f.IsDir;
		var cl = dir ? "dir" : "file";
		f.Path = path.join('/');
		$('<a></a>').text(f.Name).attr('title', f.Name).data('file', f)
			.attr('href', '#').addClass(cl).appendTo($b)
			.click(dir?clickDir:clickFile);
	}
	$b.append(up());
	$.each(files, add);
}
function sort(files) {
	files.sort(function(a, b) {
		a = a.Name.toLowerCase();
		b = b.Name.toLowerCase();
		if (a > b) return 1;
		if (a < b) return -1;
		return 0;
	});
}
function dirFiles(dir) {
	var files = [];
	var url = root + dir.Path + '/' + dir.Name;
	if (typeof cache[url] != "undefined") {
		files = cache[url];
		return;
	}
	$.ajax({
		url: url,
		dataType: "json",
		async: false,
		success: function(data) {
			cache[url] = data;
			files = data;
		}
	});
	return files;
}
function addRecursively(e) {
	var dir = $(e.target).data('file');
	var files = dirFiles(dir);
	var p = path.join('/') + '/' + dir.Name;
	function add(i, f, path) {
		if (f.Name[0] == '.' || f.Name[0] == ':') return;
		f.Path = path;
		if(f.IsDir) {
			files = dirFiles(f);
			var p = f.Path + '/' + f.Name;
			$.each(files, function(i,f) {add(i,f, p)});
		} else
			addToPlaylist(f);
	}
	$.each(files, function(i,f) {add(i,f, p)});
}
function up() {
	if (path.length == 0)
		return '';
	d = $('<div id="up"></div>');
	a = $('<a class="dir" style="width: 100%; padding: 0.5em 0; margin: 0; text-align: center; border-radius: 0;">..</a>').click(function() {
		path.pop();
		load(path);
	});
	a.appendTo(d);
	return d;
}
function clickDir(e) {
	if(e.button == 1) {
		addRecursively(e);
    	updatenext();
		return false;
	}
	path.push($(e.target).data('file').Name);
	load(path);
	return false;
}
function clickFile(e) {
	if(e.button == 1) {
		addAll();
		return false;
	}
	addToPlaylist($(e.target).data('file'));
	updatenext();
	return false;
}
function addToPlaylist(f) {
	var $ul = $('#toplay');
	var playnow = ($ul.find('li').length == 0);
	var path = f.Path+'/'+f.Name;
	var $d = $('<li></li>').text(f.Name).attr('title', path).data('file', f)
		.appendTo($ul)
		.attr('href', path)
		.click(function(e) { if (e.button == 1){ next(); return;}; play(e.target); return false; });
	if (playnow) $d.click();
}
function addAll() {
	$('#browser a.file').each(function(i, e) {
		addToPlaylist($(e).data('file'));
	});
}
function play(el) {
	var name = $(el).data('file').Name;
	var path = $(el).data('file').Path;
	var url = root+path+'/'+name;
	$('#toplay li').removeClass('playing').attr('name', '');
	$(el).addClass('playing').attr('name', 'current');
	$('audio').attr('src', url);
	updatenext();
}
function next() {
	var $current = $('li.playing')
	var $next = $current.next();
	if ($next.length) play($next);
	else $current.removeClass('playing');
	updatenext();
}
function toggle() {
	player = $('audio').get()[0];
	if(player.paused) {
		player.play();
		return;
	}
	player.pause();
}
google.load("jquery", "1");
google.load("jqueryui", "1");
google.setOnLoadCallback(init);
</script>
<style>
html, body {
    height:100%;
    min-height:100%;
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    font-size: 90%;
}
#playerbar {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 5em;
	z-index: 10;
	background-color: black;
	color: white;
	overflow: hidden;
}
#controls, #title {
	float: left;
	height: 5em;
}
#controls {
	width: 30%;
	min-width: 25em;
	padding: 1em 0;
}
#player {
	width: 100%;
}
#title {
}
h1 {
	display: block;
	width: 100%;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	font-size:1.2em;
	margin: 0;
	padding-top: 0.3em;
	padding-bottom: 0.2em;
}
#current {color: White;}
#playlist {
	position: absolute;
	top: 0;
	width:100%;
	min-height:100%;
}
#filelist {
	padding: 0;
	position: absolute;
	bottom: 0;
}
#browser 
{
	top: 1.2em;
	bottom: 0;
	padding-bottom: 2em;
}
#playlist, #browser {
	overflow-y: auto;
}
#toplay li, #browser a, #filelist a {
	display: block;
	line-height: 1em;
	height: 1em;
	cursor: pointer;
	padding: 2px 4px;
	overflow-x: hidden;
	margin: 1px 1em;
	text-decoration: none;
	font-size: 1.15em;
	white-space:nowrap;text-overflow:ellipsis;
}
#toplay li, #browser a {
	border-radius: 5px;
}
#toplay li:hover, #browser a:hover, #filelist a:hover { background: black; color: white; }
#filelist a:hover { background:blue }
#browser a { display: inline-block; width:18em; }
#browser a.dir { text-decoration: underline; }
#browser a.dir:hover { text-decoration: none; }
#browser a { color: blue; }
a { color: black; text-decoration:none; }
#toplay li.playing { font-weight:bold; }
#toplay li.error, #toplay li.error:hover {text-decoration: line-through;}
#playlist ul {list-style-type: none; margin: 0; padding: 0;}
#playlist li {margin-bottom: 2px;}
a {cursor: pointer;}
#up {-webkit-column-span:all;}
#fixed a {color:white;}
#browserpath a { display: inline;width:auto;padding:0.3ex;margin:0; }

#credits {
	position: fixed;
	top: 5em;
	right: 0;
	z-index: 15;
	padding: 0.5ex;
	font-size: 0.7em;
}
#credits a {
	color: white;
}
</style>
</head>

<body style="margin:0;height:100%;">

<div id="playerbar">
	<div id="controls">
<audio id="player" controls autoplay autobuffer>
<p>What? Your browser doesn't support &lt;audio&gt;?! Lame.</p>
</audio>
	</div>
	<div id="title" class="list">
<h1 style="padding:1ex;font-size:2em;"><a id="current" onclick="if(event.button == 1){next(); return;}; toggle();">
</a></h1>
	</div>
</div>

<div id="next" style="position:fixed; top:5em; height:2em; width:100%;
    background:whiteSmoke; border-bottom: solid 1px #ccc; cursor: pointer;
    text-align: center;" onclick="next();" title="Next"></div>
<div style="position:fixed; top:7em; bottom:40%; width:100%; overflow-y:auto;">

<div id="playlist" class="list">
<ul id="toplay"></ul>
</div>


</div>

<div id="filelist" style="position:fixed;bottom:0;width:100%;height:40%;">
<h1 style="background:#EBEFF9;"><span name="browser" id="browserpath"></span></h1>
<div id="browser" style="position:absolute;top:2em;bottom:0;width:100%;"></div>
</div>

<div id="credits">
<a href="http://bitbucket.org/yiyus/lemmy">Lemmy</a>
</div>

</body>
</html>
